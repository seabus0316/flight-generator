<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Airline Flight Generator</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    .container {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      color: #4a148c;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 10px;
      border: 2px solid #ddd;
      font-size: 1em;
      box-sizing: border-box;
    }
    .btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 1.1em;
      font-weight: bold;
      border: none;
      padding: 14px;
      border-radius: 10px;
      cursor: pointer;
    }
    .btn:hover { opacity: 0.9; }
    .mode-switch {
      text-align: center;
      margin-bottom: 20px;
    }
    .mode-switch button {
      background: #eee;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      margin: 0 5px;
      font-weight: 600;
    }
    .mode-switch button.active {
      background: #764ba2;
      color: white;
    }
    .flight-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .route {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 1.2em;
      margin: 15px 0;
    }
    .airport { font-weight: 600; color: #667eea; }
    .arrow { color: #999; }
    .no-results, .error { text-align: center; margin-top: 30px; }
    .error { color: #c33; background: #fee; padding: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåç Virtual Airline Flight Generator</h1>
    <p class="subtitle">Search or generate airline flights</p>

    <div class="mode-switch">
      <button id="modeSearch" class="active" onclick="switchMode('search')">üîç Route Search</button>
      <button id="modeGenerate" onclick="switchMode('generate')">‚öôÔ∏è Auto Generate</button>
    </div>

    <div id="searchMode">
      <label for="airline">Airline IATA Code:</label>
      <input id="airline" type="text" placeholder="e.g. BR, CI">

      <label for="dep">Departure ICAO:</label>
      <input id="dep" type="text" placeholder="e.g. RCTP">

      <label for="arr">Arrival ICAO:</label>
      <input id="arr" type="text" placeholder="e.g. RJAA">

      <button class="btn" onclick="loadFlight()">üîé Search Flight</button>
    </div>

    <div id="generateMode" style="display:none;">
      <label for="genAirline">Airline IATA Code:</label>
      <input id="genAirline" type="text" placeholder="e.g. BR, CI">

      <label for="flightType">Flight Type:</label>
      <select id="flightType">
        <option value="">-- Select Type --</option>
        <option value="Short Range">Short Range</option>
        <option value="Medium Range">Medium Range</option>
        <option value="Long Range">Long Range</option>
        <option value="Code Share">Code Share</option>
      </select>

      <label for="numFlights">Number of Flights:</label>
      <select id="numFlights">
        <option value="3">3 flights</option>
        <option value="5" selected>5 flights</option>
        <option value="10">10 flights</option>
        <option value="20">20 flights</option>
      </select>

      <button class="btn" onclick="generateRandomFlights()">üöÄ Generate Flights</button>
    </div>

    <div id="flightResult"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    function switchMode(mode) {
      document.getElementById('modeSearch').classList.remove('active');
      document.getElementById('modeGenerate').classList.remove('active');
      document.getElementById('searchMode').style.display = 'none';
      document.getElementById('generateMode').style.display = 'none';

      if (mode === 'search') {
        document.getElementById('modeSearch').classList.add('active');
        document.getElementById('searchMode').style.display = 'block';
      } else {
        document.getElementById('modeGenerate').classList.add('active');
        document.getElementById('generateMode').style.display = 'block';
      }

      document.getElementById('flightResult').innerHTML = '';
    }

    async function loadFlight() {
      const airline = document.getElementById('airline').value.trim().toUpperCase();
      const dep = document.getElementById('dep').value.trim().toUpperCase();
      const arr = document.getElementById('arr').value.trim().toUpperCase();
      const result = document.getElementById('flightResult');

      if (!airline || !dep || !arr) {
        result.innerHTML = '<div class="no-results">‚ö†Ô∏è Please fill in all fields.</div>';
        return;
      }

      result.innerHTML = '<div class="no-results">‚è≥ Searching...</div>';

      try {
        if (airline === "BR") {
          const BRData = await fetch('https://raw.githubusercontent.com/seabus0316/flight-no.-generator/refs/heads/main/BR.json').then(r => r.json());
          const flight = generateBR(dep, arr, BRData);
          result.innerHTML = flight
            ? renderCard(airline, flight, dep, arr)
            : '<div class="no-results">üòï No BR Air flight matches this route.</div>';
        } else {
          const csvText = await fetch('./flights.csv').then(r => r.text());
          const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
          
          const found = parsed.data.find(row => 
            row.icao && row.icao.trim().toUpperCase() === airline &&
            row.dep && row.dep.trim().toUpperCase() === dep &&
            row.arr && row.arr.trim().toUpperCase() === arr
          );

          if (found) {
            const flightNo = generateFlightNumber(found);
            result.innerHTML = renderCard(airline, flightNo, dep, arr);
          } else {
            result.innerHTML = '<div class="no-results">üòï No flight found for ' + airline + ' ' + dep + '-' + arr + '</div>';
          }
        }
      } catch (err) {
        result.innerHTML = '<div class="error">‚ùå ' + err.message + '</div>';
      }
    }

    function renderCard(airline, flight, dep, arr) {
      return '<div class="flight-card">' +
        '<div class="route">' +
        '<span class="airport">' + dep + '</span>' +
        '<span class="arrow">‚úàÔ∏è</span>' +
        '<span class="airport">' + arr + '</span>' +
        '</div>' +
        '<div><strong>' + airline + flight + '</strong></div>' +
        '</div>';
    }

    function generateFlightNumber(row) {
      if (row.no && row.no.trim()) {
        return row.no.trim();
      } else if (row.type && row.type.trim()) {
        const type = row.type.trim();
        let min, max;
        
        if (type === 'Short Range') {
          min = 100; max = 299;
        } else if (type === 'Medium Range') {
          min = 300; max = 599;
        } else if (type === 'Long Range') {
          min = 600; max = 999;
        } else if (type === 'Code Share') {
          min = 1000; max = 9999;
        } else {
          return '0000';
        }
        
        return String(Math.floor(Math.random() * (max - min + 1)) + min);
      }
      return '0000';
    }

    function generateBR(dep, arr, data) {
      const { airports } = data;
      for (const [category, routes] of Object.entries(airports)) {
        for (const [digit, code] of Object.entries(routes)) {
          if (Array.isArray(code)) {
            if (code[0] === dep && code[1] === arr)
              return category + digit + digit;
          } else if (code === dep || code === arr) {
            return category + digit + digit;
          }
        }
      }
      return null;
    }

    async function generateRandomFlights() {
      const airline = document.getElementById("genAirline").value.trim().toUpperCase();
      const numFlights = parseInt(document.getElementById("numFlights").value);
      const resultsDiv = document.getElementById("flightResult");

      if (!airline) {
        resultsDiv.innerHTML = '<div class="no-results">‚ö†Ô∏è Please enter an airline code</div>';
        return;
      }

      resultsDiv.innerHTML = '<div class="no-results">‚è≥ Generating flights...</div>';

      try {
        if (airline === "BR") {
          const BRData = await fetch('https://raw.githubusercontent.com/seabus0316/flight-no.-generator/refs/heads/main/BR.json').then(r => r.json());
          const allRoutes = [];
          
          for (const [category, routes] of Object.entries(BRData.airports)) {
            for (const [digit, code] of Object.entries(routes)) {
              if (Array.isArray(code)) {
                allRoutes.push({
                  dep: code[0],
                  arr: code[1],
                  flight: category + digit + digit
                });
              } else {
                for (const [digit2, code2] of Object.entries(routes)) {
                  if (digit !== digit2 && !Array.isArray(code2)) {
                    allRoutes.push({
                      dep: code,
                      arr: code2,
                      flight: category + digit + digit2
                    });
                  }
                }
              }
            }
          }

          const shuffled = allRoutes.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, numFlights);

          let html = "";
          selected.forEach(f => {
            html += renderCard(airline, f.flight, f.dep, f.arr);
          });
          resultsDiv.innerHTML = html;

        } else {
          const csvText = await fetch('./flights.csv').then(r => r.text());
          const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
          
          const airlineFlights = parsed.data.filter(row => 
            row.icao && row.icao.trim().toUpperCase() === airline
          );

          if (airlineFlights.length === 0) {
            resultsDiv.innerHTML = '<div class="error">‚ùå No data found for airline: ' + airline + '</div>';
            return;
          }

          const shuffled = airlineFlights.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, Math.min(numFlights, airlineFlights.length));

          let html = "";
          selected.forEach(row => {
            const flightNo = generateFlightNumber(row);
            html += renderCard(airline, flightNo, row.dep.trim().toUpperCase(), row.arr.trim().toUpperCase());
          });
          resultsDiv.innerHTML = html;
        }

      } catch (err) {
        resultsDiv.innerHTML = '<div class="error">‚ùå ' + err.message + '</div>';
      }
    }
  </script>
</body>
</html>
